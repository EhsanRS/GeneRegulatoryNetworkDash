<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GRN Parameter Inference</title>
  <link rel="stylesheet" href="/src/inference.css">
</head>
<body>
  <div class="dashboard">
    <header class="header">
      <div class="header-left">
        <a href="/trajectory.html" class="back-link">← Trajectory Simulation</a>
      </div>
      <div class="header-center">
        <h1>Parameter Inference</h1>
        <p class="subtitle">Find simulation parameters that produce a target cell state</p>
      </div>
      <div class="header-right">
        <button id="btn-import" class="header-btn">Import State</button>
      </div>
    </header>

    <div class="main-content">
      <!-- Left Panel: Target Setup -->
      <aside class="sidebar">
        <section class="panel">
          <h2>Target State Setup</h2>
          <p class="section-hint">Define the desired gene expression levels</p>

          <div class="target-mode-tabs">
            <button class="target-mode-tab active" data-mode="final">Final State</button>
            <button class="target-mode-tab" data-mode="timecourse">Time Course</button>
          </div>

          <div id="final-state-panel" class="target-mode-panel">
            <div class="state-preset-row">
            <span class="preset-row-label">Quick Presets:</span>
            <div class="state-preset-grid">
              <button class="state-preset-btn active" data-preset="progenitor" title="High progenitor TFs, low lineage TFs">Progenitor</button>
              <button class="state-preset-btn" data-preset="multipotent" title="Poised for multiple fates">Multipotent</button>
              <button class="state-preset-btn lineage-1" data-preset="l1" title="Lineage 1 committed">L1</button>
              <button class="state-preset-btn lineage-2" data-preset="l2" title="Lineage 2 committed">L2</button>
              <button class="state-preset-btn lineage-3" data-preset="l3" title="Lineage 3 committed">L3</button>
              <button class="state-preset-btn lineage-4" data-preset="l4" title="Lineage 4 committed">L4</button>
              <button class="state-preset-btn lineage-5" data-preset="l5" title="Lineage 5 committed">L5</button>
              <button class="state-preset-btn lineage-6" data-preset="l6" title="Lineage 6 committed">L6</button>
            </div>
          </div>

          <div class="target-section">
            <div class="section-title accordion-header" data-target="prog-targets">
              <span class="accordion-icon">▼</span> Progenitor TFs
            </div>
            <div id="prog-targets" class="target-list accordion-content"></div>
          </div>

          <div class="target-section">
            <div class="section-title accordion-header" data-target="lin-targets">
              <span class="accordion-icon">▼</span> Lineage TFs
            </div>
            <div id="lin-targets" class="target-list accordion-content"></div>
          </div>

          <div class="target-section">
            <div class="section-title accordion-header" data-target="ligand-targets">
              <span class="accordion-icon">▶</span> Ligands
            </div>
            <div id="ligand-targets" class="target-list accordion-content collapsed"></div>
          </div>

          <div class="target-section">
            <div class="section-title accordion-header" data-target="receptor-targets">
              <span class="accordion-icon">▶</span> Receptors
            </div>
            <div id="receptor-targets" class="target-list accordion-content collapsed"></div>
          </div>
          </div><!-- End final-state-panel -->

          <div id="timecourse-panel" class="target-mode-panel hidden">
            <p class="timecourse-hint">Define target expression at multiple time points</p>

            <div id="timepoint-list" class="timepoint-list">
              <!-- Timepoints will be added dynamically -->
            </div>

            <button id="btn-add-timepoint" class="add-timepoint-btn">+ Add Timepoint</button>
          </div>
        </section>

        <section class="panel">
          <h2>Gene Weights</h2>
          <p class="section-hint">Select which genes must match the target</p>

          <div class="weight-presets">
            <button class="preset-btn" data-preset="uniform">All Genes</button>
            <button class="preset-btn" data-preset="tfs-only">TFs Only</button>
            <button class="preset-btn active" data-preset="select">Select Genes</button>
          </div>

          <div id="weight-select" class="weight-select">
            <p class="select-hint">Only selected genes contribute to fitness. Unselected genes can be anything.</p>

            <div class="gene-select-section">
              <div class="gene-select-header">
                <span>Progenitor TFs</span>
                <button class="select-all-btn" data-group="prog">All</button>
                <button class="select-none-btn" data-group="prog">None</button>
              </div>
              <div id="select-prog" class="gene-select-grid"></div>
            </div>

            <div class="gene-select-section">
              <div class="gene-select-header">
                <span>Lineage TFs</span>
                <button class="select-all-btn" data-group="lin">All</button>
                <button class="select-none-btn" data-group="lin">None</button>
              </div>
              <div id="select-lin" class="gene-select-grid"></div>
            </div>

            <div class="gene-select-section">
              <div class="gene-select-header">
                <span>Ligands</span>
                <button class="select-all-btn" data-group="ligand">All</button>
                <button class="select-none-btn" data-group="ligand">None</button>
              </div>
              <div id="select-ligand" class="gene-select-grid"></div>
            </div>

            <div class="gene-select-section">
              <div class="gene-select-header">
                <span>Receptors</span>
                <button class="select-all-btn" data-group="receptor">All</button>
                <button class="select-none-btn" data-group="receptor">None</button>
              </div>
              <div id="select-receptor" class="gene-select-grid"></div>
            </div>

            <div class="selected-count">
              Selected: <span id="selected-gene-count">0</span> genes
            </div>
          </div>

          <div id="weight-custom" class="weight-custom hidden">
            <div class="weight-group">
              <label>Progenitor TFs</label>
              <input type="range" id="weight-prog" min="0" max="3" step="0.1" value="1">
              <span class="weight-val" id="val-weight-prog">1.0</span>
            </div>
            <div class="weight-group">
              <label>Lineage TFs</label>
              <input type="range" id="weight-lin" min="0" max="3" step="0.1" value="1">
              <span class="weight-val" id="val-weight-lin">1.0</span>
            </div>
            <div class="weight-group">
              <label>Ligands</label>
              <input type="range" id="weight-ligand" min="0" max="3" step="0.1" value="0.5">
              <span class="weight-val" id="val-weight-ligand">0.5</span>
            </div>
            <div class="weight-group">
              <label>Receptors</label>
              <input type="range" id="weight-receptor" min="0" max="3" step="0.1" value="0.5">
              <span class="weight-val" id="val-weight-receptor">0.5</span>
            </div>
          </div>
        </section>

        <section class="panel">
          <h2>Optimization Config</h2>

          <div class="config-group">
            <label class="checkbox-label">
              <input type="checkbox" id="opt-global" checked>
              <span>Global parameters</span>
            </label>
          </div>

          <div class="config-group">
            <label class="checkbox-label">
              <input type="checkbox" id="opt-knockouts" checked>
              <span>Gene knockouts</span>
            </label>
          </div>

          <div class="config-group">
            <label class="checkbox-label">
              <input type="checkbox" id="opt-morphogens" checked>
              <span>Morphogen per-lineage</span>
            </label>
          </div>

          <div class="config-group morphogen-sub-option">
            <label class="checkbox-label">
              <input type="checkbox" id="opt-uniform-morphogens" checked>
              <span>Uniform application</span>
            </label>
            <p class="config-hint">Apply morphogens to all cells equally (no spatial gradient)</p>
          </div>

          <div class="config-group">
            <label class="checkbox-label">
              <input type="checkbox" id="opt-modifiers">
              <span>Gene modifiers (drugs/inhibitors)</span>
            </label>
            <p class="config-hint">Optimize continuous modifiers (0=inhibited, 1=normal, 2=overexpressed)</p>
          </div>

          <div class="config-group modifier-sub-option" id="minimal-intervention-group">
            <label class="checkbox-label">
              <input type="checkbox" id="opt-minimal-intervention">
              <span>Minimize interventions</span>
            </label>
            <p class="config-hint">Find smallest set of modifiers needed (L1 regularization)</p>
          </div>

          <div class="config-group modifier-sub-option" id="intervention-penalty-group">
            <label>Sparsity Penalty: <span id="intervention-penalty-val">0.10</span></label>
            <input type="range" id="intervention-penalty" min="0.01" max="0.5" step="0.01" value="0.1">
            <p class="config-hint">Higher = fewer interventions (but may sacrifice fitness)</p>
          </div>

          <div class="config-group">
            <label class="checkbox-label">
              <input type="checkbox" id="opt-homogeneous">
              <span>Require homogeneous population</span>
            </label>
            <p class="config-hint">ALL cells must match target (optimizes worst cell, slower but ensures uniformity)</p>
          </div>

          <div class="config-group">
            <label>Max Generations: <span id="max-gen-val">200</span></label>
            <input type="range" id="max-generations" min="50" max="500" step="10" value="200">
          </div>

          <div class="config-group">
            <label>Population Size: <span id="pop-size-val">20</span></label>
            <input type="range" id="pop-size" min="10" max="50" step="5" value="20">
          </div>

          <div class="config-group">
            <label>Simulation Time: <span id="sim-time-val">12</span>h</label>
            <input type="range" id="sim-time" min="6" max="24" step="2" value="12">
          </div>

          <div class="config-group">
            <label>Target Lineage:</label>
            <select id="target-lineage">
              <option value="0">All positions (ensemble)</option>
              <option value="1">Lineage 1</option>
              <option value="2">Lineage 2</option>
              <option value="3">Lineage 3</option>
              <option value="4">Lineage 4</option>
              <option value="5">Lineage 5</option>
              <option value="6">Lineage 6</option>
            </select>
            <p class="config-hint">Select a lineage to optimize for cells in that spatial region</p>
          </div>

          <div class="button-group">
            <button id="btn-start" class="primary">Start Optimization</button>
            <button id="btn-stop" disabled>Stop</button>
          </div>
        </section>
      </aside>

      <!-- Center: Visualization -->
      <main class="visualization-area">
        <div class="viz-row">
          <div class="viz-panel progress-panel">
            <div class="viz-header">
              <h3>Optimization Progress</h3>
              <span id="status-label" class="status-label">Ready</span>
            </div>
            <div class="viz-content">
              <div class="progress-stats">
                <div class="stat">
                  <span class="stat-label">Generation</span>
                  <span class="stat-value" id="gen-display">0 / 200</span>
                </div>
                <div class="stat">
                  <span class="stat-label">Avg Fitness</span>
                  <span class="stat-value" id="fitness-display">-</span>
                </div>
                <div class="stat">
                  <span class="stat-label">Worst Cell</span>
                  <span class="stat-value" id="worst-display">-</span>
                </div>
                <div class="stat">
                  <span class="stat-label">Correlation</span>
                  <span class="stat-value" id="corr-display">-</span>
                </div>
                <div class="stat" id="intervention-stat" style="display: none;">
                  <span class="stat-label">Interventions</span>
                  <span class="stat-value" id="intervention-display">-</span>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="fitness-chart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="viz-row viz-row-split">
          <div class="viz-panel scatter-panel">
            <div class="viz-header">
              <h3>Target vs Simulated</h3>
              <div class="legend-inline scatter-legend">
                <span class="legend-dot prog"></span><span>Prog TF</span>
                <span class="legend-dot lin"></span><span>Lin TF</span>
                <span class="legend-dot ligand"></span><span>Ligand</span>
                <span class="legend-dot receptor"></span><span>Receptor</span>
              </div>
            </div>
            <div class="viz-content">
              <canvas id="scatter-chart"></canvas>
            </div>
          </div>

          <div class="viz-panel error-panel">
            <div class="viz-header">
              <h3>Top Errors</h3>
              <span class="error-hint">Genes with largest mismatch</span>
            </div>
            <div class="viz-content">
              <canvas id="error-chart"></canvas>
            </div>
          </div>
        </div>

        <div class="viz-row">
          <div class="viz-panel comparison-panel">
            <div class="viz-header">
              <h3>Expression by Gene Group</h3>
              <div class="legend-inline">
                <span class="legend-bar target"></span><span>Target</span>
                <span class="legend-bar simulated"></span><span>Simulated</span>
              </div>
            </div>
            <div class="viz-content">
              <canvas id="comparison-chart"></canvas>
            </div>
          </div>
        </div>
      </main>

      <!-- Right Panel: Results -->
      <aside class="details-panel">
        <section class="panel">
          <h2>Found Parameters</h2>
          <div id="result-params" class="result-params">
            <p class="placeholder">Run optimization to see results</p>
          </div>
        </section>

        <section class="panel">
          <h2>Knockouts</h2>
          <div id="result-knockouts" class="result-knockouts">
            <p class="placeholder">-</p>
          </div>
        </section>

        <section class="panel">
          <h2>Morphogen Strengths</h2>
          <div id="result-morphogens" class="result-morphogens">
            <p class="placeholder">-</p>
          </div>
        </section>

        <section class="panel">
          <h2>Gene Modifiers</h2>
          <p class="section-hint modifier-hint">0=inhibited, 1=normal, 2=overexpressed</p>
          <div id="result-modifiers" class="result-modifiers">
            <p class="placeholder">-</p>
          </div>
        </section>

        <section class="panel" id="sensitivity-panel">
          <h2>Sensitivity Analysis</h2>
          <p class="section-hint">Identify which parameters have biggest impact</p>
          <div id="sensitivity-content" class="sensitivity-content">
            <p class="placeholder">Run optimization first</p>
          </div>
          <div class="sensitivity-chart-container">
            <canvas id="sensitivity-chart"></canvas>
          </div>
          <button id="btn-sensitivity" class="secondary" disabled>Run Analysis</button>
        </section>

        <section class="panel" id="stability-panel">
          <h2>Stability Check</h2>
          <p class="section-hint">Verify if the found state is a stable attractor</p>
          <div id="stability-content" class="stability-content">
            <p class="placeholder">Run optimization first</p>
          </div>
          <div id="stability-drifting-genes" class="stability-drifting-genes"></div>
          <div class="stability-controls">
            <label>Threshold: <span id="stability-threshold-val">0.10</span></label>
            <input type="range" id="stability-threshold" min="0.05" max="0.5" step="0.01" value="0.1">
          </div>
          <button id="btn-stability" class="secondary" disabled>Check Stability</button>
        </section>

        <section class="panel actions-panel">
          <h2>Actions</h2>
          <div class="action-buttons">
            <button id="btn-apply" class="primary" disabled>Apply to Trajectory</button>
            <button id="btn-export" disabled>Export Parameters</button>
          </div>
        </section>
      </aside>
    </div>
  </div>

  <!-- Timepoint Edit Modal -->
  <div id="timepoint-modal" class="modal hidden">
    <div class="modal-content timepoint-modal-content">
      <div class="modal-header">
        <h3>Edit Timepoint: <span id="timepoint-modal-title">t = 0h</span></h3>
        <button class="modal-close" id="timepoint-modal-close">×</button>
      </div>
      <div class="modal-body timepoint-modal-body">
        <div class="timepoint-preset-row">
          <span class="preset-row-label">Quick Presets:</span>
          <div class="state-preset-grid" id="timepoint-preset-grid">
            <button class="state-preset-btn" data-preset="progenitor" title="High progenitor TFs, low lineage TFs">Progenitor</button>
            <button class="state-preset-btn" data-preset="multipotent" title="Poised for multiple fates">Multipotent</button>
            <button class="state-preset-btn lineage-1" data-preset="l1" title="Lineage 1 committed">L1</button>
            <button class="state-preset-btn lineage-2" data-preset="l2" title="Lineage 2 committed">L2</button>
            <button class="state-preset-btn lineage-3" data-preset="l3" title="Lineage 3 committed">L3</button>
            <button class="state-preset-btn lineage-4" data-preset="l4" title="Lineage 4 committed">L4</button>
            <button class="state-preset-btn lineage-5" data-preset="l5" title="Lineage 5 committed">L5</button>
            <button class="state-preset-btn lineage-6" data-preset="l6" title="Lineage 6 committed">L6</button>
          </div>
        </div>

        <div class="target-section">
          <div class="section-title accordion-header" data-target="tp-prog-targets">
            <span class="accordion-icon">▼</span> Progenitor TFs
          </div>
          <div id="tp-prog-targets" class="target-list accordion-content"></div>
        </div>

        <div class="target-section">
          <div class="section-title accordion-header" data-target="tp-lin-targets">
            <span class="accordion-icon">▼</span> Lineage TFs
          </div>
          <div id="tp-lin-targets" class="target-list accordion-content"></div>
        </div>

        <div class="target-section">
          <div class="section-title accordion-header" data-target="tp-ligand-targets">
            <span class="accordion-icon">▶</span> Ligands
          </div>
          <div id="tp-ligand-targets" class="target-list accordion-content collapsed"></div>
        </div>

        <div class="target-section">
          <div class="section-title accordion-header" data-target="tp-receptor-targets">
            <span class="accordion-icon">▶</span> Receptors
          </div>
          <div id="tp-receptor-targets" class="target-list accordion-content collapsed"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-timepoint-save" class="primary">Save</button>
        <button id="btn-timepoint-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="import-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Import Cell State</h3>
        <button class="modal-close">×</button>
      </div>
      <div class="modal-body">
        <p>Paste expression values (JSON format):</p>
        <textarea id="import-textarea" rows="10" placeholder='{"expression": [1.5, 0.2, ...], "weights": [1, 1, ...]}'></textarea>
      </div>
      <div class="modal-footer">
        <button id="btn-import-confirm" class="primary">Import</button>
        <button id="btn-import-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module" src="/src/inference.ts"></script>
</body>
</html>
